name: Update Jio Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------
      # STEP 1: CHECKOUT
      # --------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------
      # STEP 2: PREPARE FOLDER
      # --------------------------------------------
      - name: Prepare sources folder
        run: mkdir -p sources

      # --------------------------------------------
      # STEP 3: DOWNLOAD SOURCE
      # --------------------------------------------
      - name: Download Jio playlist
        env:
          SRC_JTV: ${{ secrets.SRC_JTV }}
        run: |
          set -e
          wget -q -O sources/jai_raw.m3u "$SRC_JTV"

      # --------------------------------------------
      # STEP 4: FILTER CHANNELS (SIMPLE)
      # --------------------------------------------
      - name: Clean playlist
        run: |
          awk '
          BEGIN { IGNORECASE=1; keep=0 }

          # ---------------- BLOCK LIST (ALL CHANNELS) ----------------
          function is_blocked(line) {
            return (line ~ /tamil|telugu|kannada|bangla|malayalam|english|test|wow|swayam|sathee|ap-|yadagiri|vidya|gujarat|bengali|asianet|maa|ptc|vijay|etv|aath|rongeen|raj|punjab|manorama|mahaa|jaya|gemini|udaya|salaam|surya|adithya|amrita|colors super$|arunprabha|girnar|kashir|oriya|saptagiri|urdu|podhigai|desi|kairali|jalsha|studio|apex|flower|jonack|kalaignar|makkal|may|mk|moon|nakshatra|bangalore|peppers|polimer|puthu|sanjha|sidharth|spondon|kiran|sun tv|sundrani|suvarna|thanthi|vaanavil|vasanth|vendhar|vissa|jomjomat|j movies|ktv|maha|mahua|pitaara|public m|sun life|tabbar|thalaa|e 24$|chintu|chutti|kochu|kushi|naap|east|sun music|sun news|nick junior|sonic marathi$|rang|sristi|teh|4 tv|6 tv|10 tv|99 tv|ananda|asmita|ganga|abc|abn|chanakya|harya|mp|ghanta|kalak|jhar|nepal|taiwan|karn|kera|bihar|mh|pradesh|him|goman|kau|logy|uk|svbc/)
          }

          # ---------------- NEWS + BUSINESS ALLOW LIST ----------------
          function is_allowed_news(line) {
            return (line ~ /zee|aaj tak|ndtv|india today|cnn|cnbc|news18|abp|republic|wion|bharat|dd news|sansad|lok sabha|rajya sabha|news nation|firstpost|times now|mirror now|business/)
          }

          /^#EXTINF/ {

            # NEWS or BUSINESS NEWS CATEGORY
            is_news = ($0 ~ /group-title="News"|group-title="Business"/)

            if (is_news) {
              if (!is_blocked($0) && is_allowed_news($0)) {
                keep=1; print
              } else {
                keep=0
              }
              next
            }

            # NON-NEWS
            if (is_blocked($0)) {
              keep=0
            } else {
              keep=1; print
            }
            next
          }

          { if (keep==1) print }
          ' sources/jai_raw.m3u > sources/jai.vxn

          rm -f sources/jai_raw.m3u

      # --------------------------------------------
      # STEP 5: COMMIT
      # --------------------------------------------
      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add sources/jai.vxn
          git commit -m "Update Jio playlist (jai.vxn)" || echo "No changes"
          git push
