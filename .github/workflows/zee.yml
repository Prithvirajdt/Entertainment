name: Update ZEE Playlist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------
      # STEP 1: CHECKOUT
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # --------------------------------------------------
      # STEP 2: CREATE FOLDERS
      # --------------------------------------------------
      - name: Create folders
        run: |
          mkdir -p sources
          mkdir -p build

      # --------------------------------------------------
      # STEP 3: DOWNLOAD SOURCES
      # --------------------------------------------------
      - name: Download ZEE sources
        env:
          SRC_ZEE5:   ${{ secrets.SRC_ZEE5 }}
          SRC_ZEENEW: ${{ secrets.SRC_ZEENEW }}
        run: |
          wget -q -O sources/zee5.m3u   "$SRC_ZEE5"   || echo "ZEE5 failed"
          wget -q -O sources/zeenew.m3u "$SRC_ZEENEW" || echo "ZEE NEW failed"

      # --------------------------------------------------
      # STEP 4: ZEE NEW (FILTER + NORMALIZE)
      # --------------------------------------------------
      - name: Process ZEE NEW
        run: |
          awk '
          BEGIN { RS="#EXTINF"; ORS="" }
          NR>1 {
            block="#EXTINF"$0
            if (tolower(block) ~ /zee/) print block
          }
          ' sources/zeenew.m3u \
          | grep -Ev 'group-title="(Business News|News|Lifestyle)"' \
          | sed \
              -e '/,Zee Anmol Cinema 2/ s/group-title="[^"]*"/group-title="Movies"/' \
          > build/zee_new.tmp

      # --------------------------------------------------
      # STEP 5: ZEE5 (FILTER + NORMALIZE)
      # --------------------------------------------------
      - name: Process ZEE5
        run: |
          if [ -f sources/zee5.m3u ]; then
            sed '1d' sources/zee5.m3u \
            | grep -Ev 'group-title="(Bengali|Gujarati|Kannada|Malayalam|Odia|Punjabi|Spiritual|Tamil|Telugu|News)"' \
            | grep -Ev ',Zee 24 Taas$' \
            | sed \
                -e '/,Zee Chitramandir/ s/group-title="[^"]*"/group-title="Movies"/' \
                -e '/,Zee Zest HD/ s/group-title="[^"]*"/group-title="Lifestyle"/' \
                -e '/,Zee Marathi/ s/group-title="[^"]*"/group-title="Entertainment"/' \
            > build/zee5.tmp
          fi

      # --------------------------------------------------
      # STEP 6: COMBINE (ZEE NEW â†’ ZEE5)
      # --------------------------------------------------
      - name: Combine playlists
        run: |
          echo "#EXTM3U" > build/combined.tmp
          cat build/zee_new.tmp >> build/combined.tmp
          cat build/zee5.tmp    >> build/combined.tmp

      # --------------------------------------------------
      # STEP 7: REMOVE CHANNELS BY NAME (CASE-INSENSITIVE)
      # --------------------------------------------------
      - name: Remove unwanted channels
        run: |
          awk '
            /^#EXTINF/ {
              name = $0
              sub(/.*?,/, "", name)

              if (tolower(name) ~ /(tamil|telugu|kannada|bangla|malayalam|english|bioskope|cinemalu|picchar|thirai|tehzeeb|biskope|keral|salaam)/) {
                skip = 1
              } else {
                skip = 0
                print
              }
              next
            }
            !skip { print }
          ' build/combined.tmp > build/combined.filtered

          mv build/combined.filtered build/combined.tmp

      # --------------------------------------------------
      # STEP 8: DEDUPLICATION (BY CHANNEL NAME, FIRST WINS)
      # --------------------------------------------------
      - name: Deduplicate
        run: |
          awk '
            /^#EXTINF/ {
              name = $0
              sub(/.*?,/, "", name)

              if (!(name in seen)) {
                seen[name] = 1
                keep = 1
                print
              } else {
                keep = 0
              }
              next
            }
            keep { print }
          ' build/combined.tmp > sources/zero.vxn

      # --------------------------------------------------
      # STEP 9: COMMIT
      # --------------------------------------------------
      - name: Commit playlist
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add sources/zero.vxn

          if git diff --cached --quiet; then
            echo "No changes"
          else
            git commit -m "Update ZEE zero.vxn playlist"
            git push
          fi
